name: Release Apple SDK

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version bump type (or "current" to re-release)'
        required: true
        type: choice
        options:
          - current
          - patch
          - minor
          - major
        default: patch

permissions:
  contents: write

jobs:
  release:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calculate version
        id: version
        run: |
          CURRENT_VERSION=$(jq -r '.apple' locanara-versions.json)
          echo "Current version: $CURRENT_VERSION"

          if [ "${{ github.event.inputs.version }}" = "current" ]; then
            NEW_VERSION="$CURRENT_VERSION"
          else
            IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
            case "${{ github.event.inputs.version }}" in
              major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
              minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
              patch) PATCH=$((PATCH + 1)) ;;
            esac
            NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          fi

          echo "New version: $NEW_VERSION"
          echo "VERSION=$NEW_VERSION" >> $GITHUB_ENV
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Verify build
        working-directory: packages/apple
        run: swift build -c release

      - name: Update version and commit
        if: github.event.inputs.version != 'current'
        run: |
          jq --arg version "$VERSION" '.apple = $version' locanara-versions.json > tmp.json
          mv tmp.json locanara-versions.json
          cp locanara-versions.json packages/docs/locanara-versions.json

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add locanara-versions.json packages/docs/locanara-versions.json

          if ! git diff --staged --quiet; then
            git commit -m "chore: bump apple SDK to $VERSION"
            git push origin main
          fi

      - name: Create tag and release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="apple-$VERSION"

          # Delete existing tag/release if re-releasing
          if [ "${{ github.event.inputs.version }}" = "current" ]; then
            git push origin --delete "$TAG_NAME" 2>/dev/null || true
            git tag -d "$TAG_NAME" 2>/dev/null || true
            gh release delete "$TAG_NAME" --yes 2>/dev/null || true
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG_NAME" -m "Apple SDK $VERSION"
          git push origin "$TAG_NAME"

          cat > /tmp/release-notes.md << EOF
          ## Locanara Apple SDK v$VERSION

          ### Installation

          **Swift Package Manager**

          In Xcode: File → Add Package Dependencies → Enter URL:
          https://github.com/hyodotdev/locanara

          **CocoaPods**
          pod 'Locanara', '~> $VERSION'

          ### Features
          - Apple Intelligence (Foundation Models)
          - On-device AI processing

          ### Requirements
          - iOS 15+ / macOS 14+ (Apple Intelligence requires iOS 26+/macOS 26+ at runtime)
          - Xcode 15+
          EOF

          gh release create "$TAG_NAME" --title "Apple SDK $VERSION" --notes-file /tmp/release-notes.md

      - name: Create and publish Locanara.podspec
        env:
          COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}
        run: |
          cat > Locanara.podspec << EOF
          Pod::Spec.new do |s|
            s.name             = 'Locanara'
            s.version          = '$VERSION'
            s.summary          = 'Unified on-device AI SDK for iOS and macOS'
            s.description      = <<-DESC
              Locanara provides a unified API for on-device AI features using Apple Intelligence.
              All processing happens locally on device for maximum privacy.
            DESC

            s.homepage         = 'https://github.com/hyodotdev/locanara'
            s.license          = { :type => 'MIT' }
            s.author           = { 'Locanara' => 'hyo@hyo.dev' }
            s.source           = { :git => 'https://github.com/hyodotdev/locanara.git', :tag => "apple-#{s.version}" }

            s.ios.deployment_target = '15.0'
            s.osx.deployment_target = '14.0'
            s.tvos.deployment_target = '15.0'
            s.watchos.deployment_target = '8.0'

            s.source_files = 'packages/apple/Sources/**/*.swift'
            s.swift_version = '5.9'
          end
          EOF

          gem install cocoapods
          pod trunk push Locanara.podspec --allow-warnings

      - name: Summary
        run: |
          echo "## Apple SDK Released" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Swift Package Manager" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "https://github.com/hyodotdev/locanara" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### CocoaPods" >> $GITHUB_STEP_SUMMARY
          echo '```ruby' >> $GITHUB_STEP_SUMMARY
          echo "pod 'Locanara', '~> $VERSION'" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
